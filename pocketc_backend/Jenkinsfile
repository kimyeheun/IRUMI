pipeline {
  agent any
  options { timestamps(); ansiColor('xterm'); buildDiscarder(logRotator(numToKeepStr: '20')) }

  environment {
    SAFE_ENV = '/opt/pocketc/.env'
    WORKDIR  = 'pocketc_backend'
    GRADLE_USER_HOME = '/var/jenkins_home/.gradle'
  }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Prepare .env') {
      steps {
        dir(env.WORKDIR) {
          sh '''
            if [ -f "${SAFE_ENV}" ]; then
              cp -f "${SAFE_ENV}" ./.env
              echo "[INFO] .env copied from ${SAFE_ENV}"
            else
              echo "[WARN] ${SAFE_ENV} not found; using existing .env if present."
            fi
            ls -la | head
          '''
        }
      }
    }

    stage('Unit & Integration Tests') {
      steps {
        dir(env.WORKDIR) {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            sh '''
              set -Eeuo pipefail
              chmod +x ./gradlew || true

              # 1) .env 로드(모든 변수를 export)
              if [ -f ./.env ]; then
                set -a
                . ./.env
                set +a
              fi

              # 2) 테스트용 Datasource 환경변수 보강(없으면 생성)
              : "${SPRING_DATASOURCE_URL:=jdbc:mysql://mysql:3306/${MYSQL_DB}?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true}"
              : "${SPRING_DATASOURCE_USERNAME:=${MYSQL_USER}}"
              : "${SPRING_DATASOURCE_PASSWORD:=${MYSQL_PASSWORD}}"
              export SPRING_DATASOURCE_URL SPRING_DATASOURCE_USERNAME SPRING_DATASOURCE_PASSWORD

              # (선택) 테스트에서 Flyway 비활성화하고 싶다면
              # export SPRING_FLYWAY_ENABLED=false

              ./gradlew --no-daemon test --stacktrace --info | tee gradle-test.log
            '''
          }
          junit allowEmptyResults: true, testResults: 'build/test-results/test/*.xml'
          archiveArtifacts allowEmptyArchive: true, artifacts: 'gradle-test.log,build/reports/tests/test/**/*'
        }
      }
    }


    stage('Build (Gradle)') {
      steps {
        dir(env.WORKDIR) {
          sh './gradlew --no-daemon bootJar'
        }
      }
    }

    stage('Deploy (Docker Compose)') {
      when { branch 'backend' }
      steps {
        dir(env.WORKDIR) {
          sh '''
            docker compose down || true
            docker compose up -d --build
            docker ps
          '''
        }
      }
    }

    stage('Smoke test') {
      when { branch 'backend' }
      steps {
        sh 'curl -fsS http://nginx/actuator/health | grep \'"status":"UP"\''
        echo '[OK] smoke test passed'
      }
    }
  }

  post {
    success { echo '✅ Deploy OK' }
    failure {
      echo '❌ Deploy Failed'
      dir(env.WORKDIR) {
        sh 'docker compose logs --no-color --tail=200 || true'
      }
      sh 'docker logs --tail=200 backend || true'
      sh 'docker logs --tail=100 nginx || true'
    }
  }
}
