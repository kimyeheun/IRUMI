pipeline {
  agent any
  options { timestamps(); ansiColor('xterm') }

  environment {
    SAFE_ENV = '/opt/pocketc/.env'
    WORKDIR  = 'pocketc_backend'   // 실제 코드/compose 위치
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Prepare .env') {
      steps {
        dir(env.WORKDIR) {
          sh '''
            if [ -f "${SAFE_ENV}" ]; then
              cp -f "${SAFE_ENV}" ./.env
              echo "[INFO] .env copied from ${SAFE_ENV}"
            else
              echo "[WARN] ${SAFE_ENV} not found; using existing .env if present."
            fi
            ls -la | head
          '''
        }
      }
    }

    stage('Build (Gradle)') {
      steps {
        dir(env.WORKDIR) {
          sh '''
            chmod +x ./gradlew || true
            ./gradlew clean build -x test
          '''
        }
      }
    }

    stage('Deploy (Docker Compose)') {
      when { branch 'backend' }   // 배포 브랜치명
      steps {
        dir(env.WORKDIR) {
          sh '''
            docker compose down || true
            docker compose up -d --build
            docker ps
          '''
        }
      }
    }
  }

  post {
    success { echo '✅ Deploy OK' }
    failure {
      echo '❌ Deploy Failed'
      dir(env.WORKDIR) {
        sh 'docker compose logs --no-color --tail=200 || true'
      }
      sh 'docker logs --tail=200 backend || true'
      sh 'docker logs --tail=100 nginx || true'
    }
  }
}
